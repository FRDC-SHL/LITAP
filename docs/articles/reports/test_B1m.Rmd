---
title: "Test - NB Field edge site 4 - Normal Run"
author: "Steffi LaZerte"
date: "`r format(Sys.Date())`"
output: html_document
---

<style>
.figure {
  max-width: 50%;
  margin: auto;
}
.table {
  width: auto;
  margin: auto;
}
</style>

```{r, include = FALSE}

knitr::opts_chunk$set(fig.width = 12, tidy = TRUE)

library(tidyverse)
library(gridExtra)
library(LITAP)

o <- "~/Projects/Business/LandmapR/TestFiles/12_FES4/FlowMapR/"
n <- "~/Projects/Business/LandmapR/Runs/B1m/"
run <- "B1m"

# Original Run DEM
orig_dem_plot <- load_orig(file = paste0(o, run, "dem.dbf"))
orig_dem <- load_odem(file = paste0(o, run, "dem.dbf"))

# LITAP Runs - DEM FILES
pond_dem <- load_new(file = paste0(n, "/final/", run, "_dem_pond.rds"))
fill_dem <- load_new(file = paste0(n, "/final/",run, "_dem_fill.rds"))
dem <- load_ndem2(file = paste0(n, "/dbf/", run, "_dem.dbf"))

# Original Run - SHED STATS
orig_pond <- load_ostat(file = paste0(o, run, "pond.dbf"))
orig_fill <- load_ostat(file = paste0(o, run, "fill.dbf"))
orig_pit <- load_ostat(file = paste0(o, run, "pit.dbf"))

# LITAP RUNS - SHED STATS
initial <- load_new(file = paste0(n, "/final/", run, "_initial.rds"))
local <- load_ndem1(file = paste0(n, "/dbf/", run, "_local.dbf"))
pond <- load_ndem1(file = paste0(n, "/dbf/", run, "_pond.dbf"))
fill <- load_ndem1(file = paste0(n, "/dbf/", run, "_fill.dbf"))
pit <- load_ndem1(file = paste0(n, "/dbf/", run, "_pit.dbf"))

# Original run - Inverted pits
orig_ipit <- load_ostat(file = paste0(o, run, "ipit.dbf"))

# LITAP RUNS - Inverted pits
ipit <- load_ndem1(file = paste0(n, "/dbf/", run, "_ipit.dbf"))

idem <- load_new(file = paste0(n, "/final/", run, "_dem_ilocal.rds"))
orig_idem <- load_orig(file = paste0(o, run, "idem.dbf"))

```

# Details

~300 min to run


#### Original Dem (Relief)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot)
```

#### Original Dem (Elevation)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot, type = "elevation")
```


# Visual Comparison

## Original vs. New Local Shed assignment

- The first shed shows initial pits which are removed in the first step of pit removal. This dem doesn't exist in the original program.
- The next two are the local sheds (shedno) after amalgamating the small ones
- Sheds are nearly identical
- Original has one extra shed (111 and 125) that New doesn't have (125 covers both)

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial") +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local") +
    labs(title = "New"), nrow = 1)
```

Upper Middle

- Here we see that in the original, Sheds 111, 104, and 105 combined into 111, and 118, 120 and 125 combined into 125
- In LITAP, these 6 watersheds combined into one, 125

```{r, echo = FALSE}
grid.arrange(
   flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "New"), nrow = 1)
```


Upper Left Corner

```{r, echo = FALSE}
grid.arrange(
     flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "New"), nrow = 1)
```

Upper Right Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "New"), nrow = 1)
```

Lower Left Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "New"), nrow = 1)
```

Lower right Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "New"), nrow = 1)
```

## Original vs. New Fill Shed assignment

- These are the fill sheds, which reflect how sheds combined during the third pit removal process
- Shapes should be identical to pond filling, just the numbers may be different
- Sheds are identical except the above differences with 111 and 125

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "fill") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "fill") +
    labs(title = "New"), nrow = 1)
```

# Numeric Comparison

## Compare pond stats

Only differences is that one watershed wasn't combined in the original, but was in LITAP. So first we'll remove those water sheds we know are different: 111/125 in orig and 125 in new

```{r}
pond <- pond %>% filter(ShedNo != 125) %>% arrange(ShedNo)
orig_pond <- orig_pond %>% filter(!(ShedNo %in% c(111, 125))) %>% arrange(ShedNo)
```

__Original Pond data__

```{r, echo = FALSE}
DT::datatable(orig_pond)
```
 __New Pond data__
```{r, echo = FALSE}
DT::datatable(pond)
```

__Differences__

```{r}
c <- compare(pond, orig_pond)
```

- All important values (pit area, pit vol, varatio, becomes) are identical, or only different by a small degree (see below)
- Differences in PitVol are smallish

```{r}
pond[c$PitVol, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_pond[c$PitVol, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

- Differences in Varatio are small
```{r}
pond[c$Varatio, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_pond[c$Varatio, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

- Differences in DrainsTo directly related to the shed we omitted for now
```{r}
pond[c$DrainsTo, ] %>% select(ShedNo, DrainsTo)
orig_pond[c$DrainsTo, ] %>% select(ShedNo, DrainsTo)
```

- Odd differences in PourElev, rounding error?
```{r}
pond[c$PourElev, ] %>% select(ShedNo, DrainsTo, OutRec, OutElev, PourElev)
orig_pond[c$PourElev, ] %>% select(ShedNo, DrainsTo, OutRec, OutElev, PourElev)
```

- Nextpit is often incorrect in ponds (not sure why)

## Compare fill stats

__Original Fill data__

```{r, echo = FALSE}
DT::datatable(orig_fill)
```

__New Fill data__

```{r, echo = FALSE}
DT::datatable(fill)
```

- Order of pit filling is not the same, probably due to the differences in sheds 111/125

Omit sheds that are different:

```{r}
fill <- fill %>% filter(ShedNo != 125)
orig_fill <- orig_fill %>% filter(!(ShedNo %in% c(111, 125)))
```

__Differences__

```{r}
fill <- arrange(fill, ShedNo)
orig_fill <- arrange(orig_fill, ShedNo)
c <- compare(fill, orig_fill)
```

- All important values (pit area, pit vol, varatio, becomes) are identical, or only different by a small degree
- Out sheds (DrainsTo) not all the same... does this matter?

Same as above with respect to DrainsTo, PitVol and Varatio


Differences in PitArea are small
```{r}
fill[c$PitArea, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_fill[c$PitArea, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

Small differences in Pit Vol
```{r}
fill[c$PitVol, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_fill[c$PitVol, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

Small differences in Varatio
```{r}
fill[c$Varatio, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_fill[c$Varatio, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

Small differences in the exact pour point (OutRec) but similar

Funny rounding error on the In Elev (elevation of one of the cells at the pour point), and PourElev. Possibly the result of changing the Elevation in the original program
```{r}
fill[c$InElev,] %>% select(ShedNo, ShedArea, PitRec, PitElev, PourElev, InRec, InElev, OutRec, OutElev)
orig_fill[c$InElev,] %>% select(ShedNo, ShedArea, PitRec, PitElev, PourElev, InRec, InElev, OutRec, OutElev)

fill[c$PourElev,] %>% select(ShedNo, PourElev, OutRec)
orig_fill[c$PourElev,] %>% select(ShedNo, PourElev, OutRec)

```


## Compare pit stats

__Original Pit data__

```{r, echo = FALSE}
DT::datatable(orig_pit)
```

__New Pit data__

```{r, echo = FALSE}
DT::datatable(pit)
```

Omit sheds we don't have:

```{r}
pit <- pit %>% filter(ShedNo != 125) %>% arrange(ShedNo)
orig_pit <- orig_pit %>% filter(!(ShedNo %in% c(111, 125))) %>% arrange(ShedNo)
```


__Differences__

```{r}
c <- compare(pit, orig_pit)
```

Same conclusions as above

## Inverted DEM
Black dots indicate pits, or, as this is inverted, peaks

Look identical

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

Upper Middle

- Some ShedNo's different (i.e. 77 and 75) but same shed, just different label

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "New"), nrow = 1)
```

Upper Left Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "New"), nrow = 1)
```

Upper Right Corner

- Some ShedNo's different (i.e. 77 and 75) but same shed, just different label


```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "New"), nrow = 1)
```

Lower Left Corner

- Some ShedNo's different (i.e. 130/129, 138/137, 143/142) but same shed, just different label

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "New"), nrow = 1)
```

Lower right Corner

- Some ShedNo's different (i.e. 166/164, 172/169, 170/172, 183/182, 182/181) but same shed, just different label


```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "New"), nrow = 1)
```

Some of the shednos are different, so re-lable


```{r}
ipit <- shedno_update2(ipit, dem = select(idem, ShedNo = local_shed)) %>% arrange(ShedNo)
orig_ipit <- shedno_update2(orig_ipit, dem = select(orig_idem, ShedNo = fill_shed)) %>% arrange(ShedNo)
```

```{r}
c <- compare(ipit, orig_ipit)
```

- Pit and Shed areas off by a small amount (odd that Shed Area off, usually identical)
- Leads to small differences in pit volume and varatio

Original vs. New differences in Pit volume:
```{r}
orig_ipit[c$PitVol,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
ipit[c$PitVol,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
```

Original vs. New differences in Shed Area
```{r}
orig_ipit[c$ShedArea,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
ipit[c$ShedArea,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
```

Original vs. New differences in Pit Area: Actually somewhat large discrepancy, here.
```{r}
orig_ipit[c$PitArea,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
ipit[c$PitArea,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
```

- small differences in exact pit location (off by one cell at most)
- small differences in exact overflow point

Original vs. New differences in flow out point (seqno/row/col)
```{r}
ipit[c$OutElev,] %>% select(ShedNo, PourElev, OutRec, OutRow, OutCol, OutElev)
orig_ipit[c$OutElev,] %>% select(ShedNo, PourElev, OutRec, OutRow, OutCol, OutElev)
```

- DrainsTo different because original doesn't use it

