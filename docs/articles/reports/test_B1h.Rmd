---
title: "Test - NB Field edge site 4 - High Threshold"
author: "Steffi LaZerte"
date: "`r format(Sys.Date())`"
output: html_document
---

<style>
.figure {
  max-width: 50%;
  margin: auto;
}
.table {
  width: auto;
  margin: auto;
}
</style>

```{r, include = FALSE}

knitr::opts_chunk$set(fig.width = 12, tidy = TRUE)

library(tidyverse)
library(gridExtra)
library(LITAP)

o <- "~/Projects/Business/LandmapR/TestFiles/12_FES4/HighThreshold_FlowMapR/"
n <- "~/Projects/Business/LandmapR/Runs/B1h/"
run <- "B1h"

# Original Run DEM
orig_dem_plot <- load_orig(file = paste0(o, run, "dem.dbf"))
orig_dem <- load_odem(file = paste0(o, run, "dem.dbf"))

# LITAP Runs - DEM FILES
pond_dem <- load_new(file = paste0(n, "/final/", run, "_dem_pond.rds"))
fill_dem <- load_new(file = paste0(n, "/final/",run, "_dem_fill.rds"))
dem <- load_ndem2(file = paste0(n, "/dbf/", run, "_dem.dbf"))

# Original Run - SHED STATS
orig_pond <- load_ostat(file = paste0(o, run, "pond.dbf"))
orig_fill <- load_ostat(file = paste0(o, run, "fill.dbf"))
orig_pit <- load_ostat(file = paste0(o, run, "pit.dbf"))

# LITAP RUNS - SHED STATS
initial <- load_new(file = paste0(n, "/final/", run, "_initial.rds"))
local <- load_ndem1(file = paste0(n, "/dbf/", run, "_local.dbf"))
pond <- load_ndem1(file = paste0(n, "/dbf/", run, "_pond.dbf"))
fill <- load_ndem1(file = paste0(n, "/dbf/", run, "_fill.dbf"))
pit <- load_ndem1(file = paste0(n, "/dbf/", run, "_pit.dbf"))

# Original run - Inverted pits
orig_ipit <- load_ostat(file = paste0(o, run, "ipit.dbf"))

# LITAP RUNS - Inverted pits
ipit <- load_ndem1(file = paste0(n, "/dbf/", run, "_ipit.dbf"))

idem <- load_new(file = paste0(n, "/final/", run, "_dem_ilocal.rds"))
orig_idem <- load_orig(file = paste0(o, run, "idem.dbf"))

```

# Details

~ 293 min to run

Almost identical to Bhm (regular run) because algorithm doesn't eliminate small pits on the edge in the initial run of pit removal. As most pits are edge pits, these are kept, even with the higher threshold values.


#### Original Dem (Relief)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot)
```

#### Original Dem (Elevation)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot, type = "elevation")
```


# Visual Comparison

## Original vs. New Local Shed assignment

- The first shed shows initial pits which are removed in the first step of pit removal. This dem doesn't exist in the original program.
- The next two are the local sheds (shedno) after amalgamating the small ones
- Sheds are nearly identical
- Original has one extra shed (111 and 125) that New doesn't have (125 covers both)

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial") +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local") +
    labs(title = "New"), nrow = 1)
```

Upper Middle

- Here we see that in the original, Sheds 111, 104, and 105 combined into 111, and 118, 120 and 125 combined into 125
- In LITAP, these 6 watersheds combined into one, 125

```{r, echo = FALSE}
grid.arrange(
   flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(200, 400)) +
    labs(title = "New"), nrow = 1)
```


Upper Left Corner

```{r, echo = FALSE}
grid.arrange(
     flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(0, 350)) +
    labs(title = "New"), nrow = 1)
```

Upper Right Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(0, 200), clim = c(200, Inf)) +
    labs(title = "New"), nrow = 1)
```

Lower Left Corner

- Different labelling of 3/68

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(0, 200)) +
    labs(title = "New"), nrow = 1)
```

Lower right Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(350, Inf)) +
    labs(title = "New"), nrow = 1)
```

## Original vs. New Fill Shed assignment

- These are the fill sheds, which reflect how sheds combined during the third pit removal process
- Shapes should be identical to pond filling, just the numbers may be different
- Sheds are identical except the above differences with 111 and 125 and different labels to 3/68

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "fill") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "fill") +
    labs(title = "New"), nrow = 1)
```

# Numeric Comparison

## Compare pond stats

__Original Pond data__

```{r, echo = FALSE}
DT::datatable(orig_pond)
```
 __New Pond data__
```{r, echo = FALSE}
DT::datatable(pond)
```

Only differences is that one watershed wasn't combined in the original, but was in LITAP and that one watershed has a different label. So first we'll remove those water sheds we know are different: 111/125 in orig and 125 in new. And we're relabel to make sure they have all the same numbering

```{r}
pond <- pond %>% filter(ShedNo != 125) %>% shedno_update2() %>% arrange(ShedNo)
orig_pond <- orig_pond %>% filter(!(ShedNo %in% c(111, 125))) %>% shedno_update2() %>% arrange(ShedNo)
```


__Differences__

```{r}
c <- compare(pond, orig_pond)
```

- Differences in PitElev due to differences in PitRec, and to the fact that LITAP doesn't modify the DEM but the original program would smooth out initial pits by filling them in, thus increasing the minimum elevation point.
```{r}
pond[c$PitElev, ] %>% select(ShedNo, PitRec, PitRow, PitCol, PitElev, ShedArea)
orig_pond[c$PitElev, ] %>% select(ShedNo, PitRec, PitRow, PitCol, PitElev, ShedArea)
```

- See the pit center (black dots) is different for shed 3/68
```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local", rlim = c(690, Inf), clim = c(0, 130), pits = TRUE) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local", rlim = c(690, Inf), clim = c(0, 130), pits = TRUE) +
    labs(title = "New"), nrow = 2)
```

- Fairly substantial difference in PitVol, and Variatio here, probably related to differences in pit center

```{r}
pond[c$PitVol, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_pond[c$PitVol, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

- Differences in Varatio are small, except for the Varatio related to the one with different pit center (19 in relabled sheds, 3/68 in original/LITAP sheds) 
```{r}
pond[c$Varatio, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
orig_pond[c$Varatio, ] %>% select(ShedNo, PitArea, PitVol, Varatio)
```

- Nextpit is often incorrect in ponds (not sure why)

## Compare fill stats

__Original Fill data__

```{r, echo = FALSE}
DT::datatable(orig_fill)
```

__New Fill data__

```{r, echo = FALSE}
DT::datatable(fill)
```

- Order of pit filling is not the same, probably due to the differences in sheds 111/125?

Omit sheds that are different:

```{r}
fill <- fill %>% filter(ShedNo != 125) %>% shedno_update2() %>% arrange(ShedNo)
orig_fill <- orig_fill %>% filter(!(ShedNo %in% c(111, 125))) %>% shedno_update2() %>% arrange(ShedNo)
```

__Differences__

```{r}
c <- compare(fill, orig_fill)
```

- Same issue as above with watershed 19 (3/68) having a different pit location, leads to differences in PitRec, PitElev, PitVol, Varatio, OutRec, and OutElev:

```{r}
fill[c$PitRec, ] %>% select(ShedNo, PitRec, PitElev, PitArea, PitVol, Varatio, OutRec, OutElev)
orig_fill[c$PitRec, ] %>%  select(ShedNo, PitRec, PitElev, PitArea, PitVol, Varatio, OutRec, OutElev)
```

- Differences besides that watershed are minimal:
```{r}
c <- compare(filter(fill, ShedNo != 19), filter(orig_fill, ShedNo != 19))
```

## Compare pit stats

__Original Pit data__

```{r, echo = FALSE}
DT::datatable(orig_pit)
```

__New Pit data__

```{r, echo = FALSE}
DT::datatable(pit)
```

Omit sheds we don't have:

```{r}
pit <- pit %>% filter(ShedNo != 125) %>% shedno_update2() %>% arrange(ShedNo)
orig_pit <- orig_pit %>% filter(!(ShedNo %in% c(111, 125))) %>% shedno_update2() %>% arrange(ShedNo)
```


__Differences__

```{r}
c <- compare(pit, orig_pit)
```

Same conclusions as above

```{r}
c <- compare(filter(pit, ShedNo != 19), filter(orig_pit, ShedNo != 19))
```

## Inverted DEM
Black dots indicate pits, or, as this is inverted, peaks

Look identical, except some differences in labels, and some differences in peaks

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

Upper Middle

- Some ShedNo's different (i.e. 77/75, 34/54) but same shed, just different label

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(0, 100), clim = c(200, 400), pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(200, 400), pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

Upper Left Corner

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(0, 100), clim = c(0, 350), pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(0, 100), clim = c(0, 350), pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

Upper Right Corner

- Some ShedNo's different (i.e. 77/75, 34/84, 182/7) but same shed, just different label
- Difference in peak for Shed 34/54 (because LITAP doesn't modify initial file Elevations whereas the original program does)

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(0, 200), clim = c(200, Inf), pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(0, 200), clim = c(200, Inf), pits = TRUE) +
    labs(title = "New"), nrow = 1)
```


Lower Left Corner

- Some ShedNo's different but same shed, just different label
- 67/71 pits/peak different location 

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(600, Inf), clim = c(0, 200), pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(0, 200), pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

Lower right Corner

- Some ShedNo's different but same shed, just different label
- 67/71 pits/peaks different location 

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", rlim = c(600, Inf), clim = c(350, Inf), pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", rlim = c(600, Inf), clim = c(350, Inf), pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

Some of the shednos are different, so re-lable


```{r}
ipit <- shedno_update2(ipit, dem = select(idem, ShedNo = local_shed)) %>% arrange(ShedNo)
orig_ipit <- shedno_update2(orig_ipit, dem = select(orig_idem, ShedNo = fill_shed)) %>% arrange(ShedNo)
```

**Break up to compare**

Compare upper left

```{r}
sub <- filter(ipit, PitRow < 350, PitCol < 325)
orig_sub <- filter(orig_ipit, PitRow < 350, PitCol < 325)
c <- compare(sub, orig_sub)
```

- PitVol, Varatio, Pit Area, OutElev all for the same shed, pit area fairly different
```{r}
orig_sub[c$PitVol,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio, OutElev)
sub[c$PitVol,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio, OutElev)
```

- In Elev minor rounding difference
```{r}
orig_sub[c$InElev,] %>% select(ShedNo, ShedArea, InElev)
sub[c$InElev,] %>% select(ShedNo, ShedArea, InElev)
```

Compare upper right

```{r}
sub <- filter(ipit, PitRow < 350, PitCol >= 325)
orig_sub <- filter(orig_ipit, PitRow < 350, PitCol >= 325)
c <- compare(sub, orig_sub)
```

- Only three watersheds in this corner, shed 8 has different pit location, leads to differences in Pit Area, PitVol and Varatio
```{r}
orig_sub %>% select(ShedNo, PitRec, PitElev, ShedArea, PitArea, PitVol, Varatio)
sub %>% select(ShedNo, PitRec, PitElev, ShedArea, PitArea, PitVol, Varatio)
```

Compare lower left

```{r}
sub <- filter(ipit, PitRow > 350, PitCol < 325)
orig_sub <- filter(orig_ipit, PitRow > 350, PitCol < 325)
c <- compare(sub, orig_sub)
```

Lots of confused assignments, some mixed up (i.e. sheds 42 and 39 should be matched up)
- Nearly all differences stem from this mixup
```{r}
orig_sub[c$PitRec,] %>% select(ShedNo, PitRec, PitElev, ShedArea, PitArea, PitVol, Varatio)
sub[c$PitRec,] %>% select(ShedNo, PitRec, PitElev, ShedArea, PitArea, PitVol, Varatio)
```

All other differences are minor (expect shed 18 PitVol)

```{r}
orig_sub %>% filter(ShedNo %in% orig_sub$ShedNo[c(1, 2, 5, 6, 7, 8)]) %>% select(ShedNo, PitRec, PitElev, ShedArea, PitVol, Varatio, InElev)
sub %>% filter(ShedNo %in% orig_sub$ShedNo[c(1, 2, 5, 6, 7, 8)]) %>% select(ShedNo, PitRec, PitElev, ShedArea, PitVol, Varatio, InElev)
```

Compare lower right

```{r}
sub <- filter(ipit, PitRow < 350, PitCol < 325)
orig_sub <- filter(orig_ipit, PitRow < 350, PitCol < 325)
c <- compare(sub, orig_sub)
```

Minor differences, except shed 3 PitArea

```{r}
orig_sub %>% filter(ShedNo %in% sub$ShedNo[c(1, 3,7,10)]) %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio, InElev, OutElev)
sub %>% filter(ShedNo %in% sub$ShedNo[c(1, 3,7,10)]) %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio, InElev, OutElev)
```
