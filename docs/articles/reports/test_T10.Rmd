---
title: "Test - Hypothetical Tilted Plane 1"
author: "Steffi LaZerte"
date: "`r format(Sys.Date())`"
output: html_document
---

<style>
.figure {
  max-width: 50%;
  margin: auto;
}
.table {
  width: auto;
  margin: auto;
}
</style>

```{r, include = FALSE}

knitr::opts_chunk$set(fig.width = 12, tidy = TRUE)

library(tidyverse)
library(gridExtra)
library(LITAP)

o <- "~/Projects/Business/LandmapR/TestFiles/07_T1//FlowMapR/"
n <- "~/Projects/Business/LandmapR/Runs/T10/"
run <- "T10"

# Original Run DEM
orig_dem_plot <- load_orig(file = paste0(o, run, "dem.dbf"))
orig_dem <- load_odem(file = paste0(o, run, "dem.dbf"))

# LITAP Runs - DEM FILES
pond_dem <- load_new(file = paste0(n, "/final/", run, "_dem_pond.rds"))
fill_dem <- load_new(file = paste0(n, "/final/",run, "_dem_fill.rds"))
dem <- load_ndem2(file = paste0(n, "/dbf/", run, "_dem.dbf"))

# Original Run - SHED STATS
orig_pond <- load_ostat(file = paste0(o, run, "pond.dbf"))
orig_fill <- load_ostat(file = paste0(o, run, "fill.dbf"))
orig_pit <- load_ostat(file = paste0(o, run, "pit.dbf"))

# LITAP RUNS - SHED STATS
initial <- load_new(file = paste0(n, "/final/", run, "_initial.rds"))
local <- load_ndem1(file = paste0(n, "/dbf/", run, "_local.dbf"))
#pond <- load_ndem1(file = paste0(n, "/dbf/", run, "_pond.dbf"))
#fill <- load_ndem1(file = paste0(n, "/dbf/", run, "_fill.dbf"))
#pit <- load_ndem1(file = paste0(n, "/dbf/", run, "_pit.dbf"))

# Original run - Inverted pits
orig_ipit <- load_ostat(file = paste0(o, run, "ipit.dbf"))

# LITAP RUNS - Inverted pits
#ipit <- load_ndem1(file = paste0(n, "/dbf/", run, "_ipit.dbf"))

idem <- load_new(file = paste0(n, "/final/", run, "_dem_ilocal.rds"))
orig_idem <- load_orig(file = paste0(o, run, "idem.dbf"))

```

# Details

~ 1.75 min to run  


#### Original Dem (Relief)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot)
```

#### Original Dem (Elevation)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot, type = "elevation")
```


# Visual Comparison


## Original vs. New Local Shed assignment

- The first shed shows initial pits which are removed in the first step of pit removal. This dem doesn't exist in the original program.
- The next two are the local sheds (shedno) after amalgamating the small ones
- Sheds are identical
- Only one shed!

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial") +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local") +
    labs(title = "New"), nrow = 1)
```

## Original vs. New Fill Shed assignment

- These are the fill sheds, which reflect how sheds combined during the third pit removal process
- Shapes should be identical to pond filling, just the numbers may be different
- Sheds are identical

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "fill") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "fill") +
    labs(title = "New"), nrow = 1)
```

# Numeric Comparison

## Compare pit stats

__Original Pit data__

```{r, echo = FALSE}
DT::datatable(orig_pit)
```

__New Pit data__

No data output with only one shed


## Compare pond stats

No data output with only one shed for either new or orignical


## Compare fill stats
No data output with only one shed for either new or orignical


## Inverted DEM
Black dots indicate pits, or, as this is inverted, peaks.

Here peaks are in different places, but likely due to selection based on ties (as the entire top of the dem is the same elevation in a given row)

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

No output for new if only one watershed
