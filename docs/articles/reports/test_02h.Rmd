---
title: "Test - AB provost site High Threshold"
author: "Steffi LaZerte"
date: "`r format(Sys.Date())`"
output: html_document
---

<style>
.figure {
  max-width: 50%;
  margin: auto;
}
.table {
  width: auto;
  margin: auto;
}
</style>

```{r, include = FALSE}

knitr::opts_chunk$set(fig.width = 12, tidy = TRUE)

library(tidyverse)
library(gridExtra)
library(LITAP)

o <- "~/Projects/Business/LandmapR/TestFiles/11_Ab02PV/HighThreshold_FlowMapR/"
n <- "~/Projects/Business/LandmapR/Runs/02h/"
run <- "02h"

# Original Run Files
input <- foreign::read.dbf(paste0(o, run, "ELEV.DBF")) %>%
  LITAP:::file_prep(nrows = 184, ncols = 187, missing_value = -9999)

# Original Run DEM
orig_dem_plot <- load_orig(file = paste0(o, run, "dem.dbf"))
orig_dem <- load_odem(file = paste0(o, run, "dem.dbf"))

# LITAP Runs - DEM FILES
pond_dem <- load_new(file = paste0(n, "/final/", run, "_dem_pond.rds"))
fill_dem <- load_new(file = paste0(n, "/final/",run, "_dem_fill.rds"))
dem <- load_ndem2(file = paste0(n, "/dbf/", run, "_dem.dbf"))

# Original Run - SHED STATS
orig_pond <- load_ostat(file = paste0(o, run, "pond.dbf"))
orig_fill <- load_ostat(file = paste0(o, run, "fill.dbf"))
orig_pit <- load_ostat(file = paste0(o, run, "pit.dbf"))

# LITAP RUNS - SHED STATS
initial <- load_new(file = paste0(n, "/final/", run, "_initial.rds"))
local <- load_ndem1(file = paste0(n, "/dbf/", run, "_local.dbf"))
pond <- load_ndem1(file = paste0(n, "/dbf/", run, "_pond.dbf"))
fill <- load_ndem1(file = paste0(n, "/dbf/", run, "_fill.dbf"))
pit <- load_ndem1(file = paste0(n, "/dbf/", run, "_pit.dbf"))

# Original run - Inverted pits
orig_ipit <- load_ostat(file = paste0(o, run, "ipit.dbf"))

# LITAP RUNS - Inverted pits
ipit <- load_ndem1(file = paste0(n, "/dbf/", run, "_ipit.dbf"))

idem <- load_new(file = paste0(n, "/final/", run, "_dem_ilocal.rds"))
orig_idem <- load_orig(file = paste0(o, run, "idem.dbf"))

```

# Details

6.53 min to run


#### Original Dem (Relief)

Here you can see where the elevations have been filled in the inital pits (the little plateaus)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot)
```

Compared to the input file:
```{r, echo = FALSE, fig.width = 5}
flow_plot(input)
```


#### Original Dem (Elevation)
```{r, echo = FALSE}
flow_plot(orig_dem_plot, type = "elevation")
```


# Visual Comparison


## Original vs. New Local Shed assignment

- The first shed shows initial pits which are removed in the first step of pit removal. This dem doesn't exist in the original program.
- The next two are the local sheds (shedno) after amalgamating the small ones
- Sheds are identical

```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial") +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local") +
    labs(title = "New"), nrow = 1)
```

## Original vs. New Fill Shed assignment

- These are the fill sheds, which reflect how sheds combined during the third pit removal process
- Shapes should be identical to pond filling, just the numbers may be different
- Sheds are identical

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "fill") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "fill") +
    labs(title = "New"), nrow = 1)
```

# Numeric Comparison

## Compare pond stats

__Original Pond data__

```{r, echo = FALSE}
DT::datatable(orig_pond)
```
 __New Pond data__
```{r, echo = FALSE}
DT::datatable(pond)
```

__Differences__

```{r}
pond <- arrange(pond, ShedNo)
orig_pond <- arrange(orig_pond, ShedNo)
c <- compare(pond, orig_pond)
```

- All important values (pit area, pit vol, varatio, becomes) are identical, or only different by a small degree

- Some Pit centers off by a cell (tie breaking differences, as elev is the same)
```{r}
pond[c$PitRec,] %>% select(ShedNo, PitRec, PitElev, PitArea, PitVol, Varatio)
orig_pond[c$PitRec,] %>% select(ShedNo, PitRec, PitElev, PitArea, PitVol, Varatio)
```

- Some minor differences in pit Vol (except shed 7, which fairly large, likely due to differences in pit rec)
```{r}
pond[c$PitArea,] %>% select(ShedNo, PitRec, PitElev, PitArea, PitVol, Varatio)
orig_pond[c$PitArea,] %>% select(ShedNo, PitRec, PitElev, PitArea, PitVol, Varatio)
```

## Compare fill stats

__Original Fill data__

```{r, echo = FALSE}
DT::datatable(orig_fill)
```

__New Fill data__

```{r, echo = FALSE}
DT::datatable(fill)
```

- Order of pit filling is almost the same, but 7 fills last with 30 in the orig

__Differences__

```{r}
fill <- arrange(fill, ShedNo)
orig_fill <- arrange(orig_fill, ShedNo)
c <- compare(fill, orig_fill)
```
Same as above


## Compare pit stats


__Original Pit data__

```{r, echo = FALSE}
DT::datatable(orig_pit)
```

__New Pit data__

```{r, echo = FALSE}
DT::datatable(pit)
```

__Differences__

```{r}
pit <- pit %>% arrange(ShedNo)
orig_pit <- orig_pit %>% arrange(ShedNo)
c <- compare(pit, orig_pit)
```

Same conclusions as above


## Inverted DEM
Black dots indicate pits, or, as this is inverted, peaks

- All the same, except some shednames and the peak of 22/21

```{r, echo = FALSE}
grid.arrange(
  flow_plot(idem, shed = TRUE, shed_type = "initial") +
    labs(title = "Initial"),
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

```{r}
ipit <- shedno_update2(ipit, dem = select(idem, ShedNo = local_shed)) %>% arrange(ShedNo)
orig_ipit <- shedno_update2(orig_ipit, dem = select(orig_idem, ShedNo = fill_shed)) %>% arrange(ShedNo)
c <- compare(ipit, orig_ipit)
```

- Some different Peaks, one very different elevation (LITAP < original because of original program filling in initial pit elevations), others likely tiebreakers
 
```{r}
ipit[c$PitRec,] %>% select(ShedNo, PitRec, PitRow, PitCol, PitElev, ShedArea, PitArea, PitVol, Varatio)
orig_ipit[c$PitRec,]  %>% select(ShedNo, PitRec, PitRow, PitCol, PitElev, ShedArea, PitArea, PitVol, Varatio)
```

- Shed Area differences lead to Varatio and possibly pit vol differences, but all approx similar
```{r}
ipit[c$ShedArea,] %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
orig_ipit[c$ShedArea,]  %>% select(ShedNo, ShedArea, PitArea, PitVol, Varatio)
```

- Small differences in flow out point

```{r}
ipit[c$OutElev,] %>% select(ShedNo, PourElev, PitRec, OutRec, OutRow, OutCol, OutElev)
orig_ipit[c$OutElev,] %>% select(ShedNo, PourElev, PitRec, OutRec, OutRow, OutCol, OutElev)
```


