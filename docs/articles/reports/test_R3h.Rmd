---
title: "Test - Hypothetical Incline Medium Relief - Missing values"
author: "Steffi LaZerte"
date: "`r format(Sys.Date())`"
output: html_document
---

<style>
.figure {
  max-width: 50%;
  margin: auto;
}
.table {
  width: auto;
  margin: auto;
}
</style>

```{r, include = FALSE}

knitr::opts_chunk$set(fig.width = 12, tidy = TRUE)

library(tidyverse)
library(gridExtra)
library(LITAP)

o <- "~/Projects/Business/LandmapR/TestFiles/06_I3/MissingValue_FlowMarR/"
n <- "~/Projects/Business/LandmapR/Runs/I3h/"
run <- "I3h"

# Original Run DEM
orig_dem_plot <- load_orig(file = paste0(o, run, "dem.dbf"))
orig_dem <- load_odem(file = paste0(o, run, "dem.dbf"))

# LITAP Runs - DEM FILES
pond_dem <- load_new(file = paste0(n, "/final/", run, "_dem_pond.rds"))
fill_dem <- load_new(file = paste0(n, "/final/",run, "_dem_fill.rds"))
dem <- load_ndem2(file = paste0(n, "/dbf/", run, "_dem.dbf"))

# Original Run - SHED STATS
orig_pond <- load_ostat(file = paste0(o, run, "pond.dbf"))
orig_fill <- load_ostat(file = paste0(o, run, "fill.dbf"))
orig_pit <- load_ostat(file = paste0(o, run, "pit.dbf"))

# LITAP RUNS - SHED STATS
initial <- load_new(file = paste0(n, "/final/", run, "_initial.rds"))
local <- load_ndem1(file = paste0(n, "/dbf/", run, "_local.dbf"))
pond <- load_ndem1(file = paste0(n, "/dbf/", run, "_pond.dbf"))
fill <- load_ndem1(file = paste0(n, "/dbf/", run, "_fill.dbf"))
pit <- load_ndem1(file = paste0(n, "/dbf/", run, "_pit.dbf"))

# Original run - Inverted pits
orig_ipit <- load_ostat(file = paste0(o, run, "ipit.dbf"))

# LITAP RUNS - Inverted pits
ipit <- load_ndem1(file = paste0(n, "/dbf/", run, "_ipit.dbf"))

idem <- load_new(file = paste0(n, "/final/", run, "_dem_ilocal.rds"))
orig_idem <- load_orig(file = paste0(o, run, "idem.dbf"))

```

# Details

2.22 min to run


#### Original Dem (Relief)
```{r, echo = FALSE, fig.width = 5}
flow_plot(orig_dem_plot, missing = -9999)
```

#### Original Dem (Elevation)
```{r, echo = FALSE,fig.width = 5}
flow_plot(orig_dem_plot, type = "elevation", missing = -9999)
```


# Visual Comparison

## Original vs. New Local Shed assignment

- The first shed shows initial pits which are removed in the first step of pit removal. This dem doesn't exist in the original program.
- The next two are the local sheds (shedno) after amalgamating the small ones
- Sheds are identical except that in original, missing values get a shed of 0 whereas they're marked as NA in LITAP
- Also note that size of sheds 1 and 4 differs


```{r, echo = FALSE}
grid.arrange(
  flow_plot(fill_dem, shed = TRUE, shed_type = "initial") +
    labs(title = "Initial (New)"),
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "local") +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "local") +
    labs(title = "New"), nrow = 1)
```

## Original vs. New Fill Shed assignment

- These are the fill sheds, which reflect how sheds combined during the third pit removal process
- Shapes should be identical to pond filling, just the numbers may be different
- Sheds are similar except that in original, missing values get a shed of 0 whereas they're marked as NA in LITAP
- Also interesting is that Shed 2 in the original is shorter than shed 2 in LITAP
- Pits in different spots too (due to tie breaking differences)

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_dem_plot, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "Original"),
  flow_plot(fill_dem, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

# Numeric Comparison

## Compare pond stats

__Original Pond data__

```{r, echo = FALSE}
DT::datatable(orig_pond)
```
 __New Pond data__
```{r, echo = FALSE}
DT::datatable(pond)
```

__Differences__

```{r}
c <- compare(pond, orig_pond)
```

- Pit recs different because of tie breaking putting the pits on the top or bottom
- ShedArea, Pit Area different because of the difference in sheds 1 and 4
- Pit Vol presumably different because of differences in pits locations 

```{r}
pond %>% select(ShedNo, PitRec, ShedArea, PitArea, PitVol, Varatio, InRec, OutRec)
orig_pond %>% select(ShedNo, PitRec, ShedArea, PitArea, PitVol, Varatio, InRec, OutRec)
```


## Compare fill stats

__Original Fill data__

```{r, echo = FALSE}
DT::datatable(orig_fill)
```

__New Fill data__

```{r, echo = FALSE}
DT::datatable(fill)
```

- Order of pit filling is the same

__Differences__

```{r}
c <- compare(fill, orig_fill)
```

Same as above

## Compare pit stats

__Original Pit data__

```{r, echo = FALSE}
DT::datatable(orig_pit)
```

__New Pit data__

```{r, echo = FALSE}
DT::datatable(pit)
```

__Differences__

```{r}
c <- compare(pit, orig_pit)
```

Same conclusions as above


## Inverted DEM
Black dots indicate pits, or, as this is inverted, peaks

```{r, echo = FALSE}
grid.arrange(
  flow_plot(orig_idem, shed = TRUE, shed_type = "fill", pits = TRUE) +
    labs(title = "Original"),
  flow_plot(idem, shed = TRUE, shed_type = "local", pits = TRUE) +
    labs(title = "New"), nrow = 1)
```

```{r}
c <- compare(ipit, orig_ipit)
```

- All values close if not identical, all differences likely due to different pit centres and the differences in size of sheds 2 and 4

```{r}
ipit %>% select(PitRec, ShedArea, PitVol, Varatio, InRec, OutRec)
orig_ipit %>% select(PitRec, ShedArea, PitVol, Varatio, InRec, OutRec)
```

